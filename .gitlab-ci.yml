stages:
  - changelog

update_changelog:
  stage: changelog
  image: python:3.12
  script:
    - pip install .
    - rm -rf build smart_changelog.egg-info
    - |
        if [ -f .env ]; then
          set -a
          . ./.env
          set +a
        fi
        : "${JIRA_URL:?JIRA_URL must be set}"
        : "${JIRA_TOKEN:?JIRA_TOKEN must be set}"
        SMART_CHANGELOG_SKIP_COMMIT=1 smart-changelog update
    - git config user.email "bot@company.com"
    - git config user.name "SmartChangelog Bot"
    - git add CHANGELOG.md
    - git commit -m "chore: update changelog [skip ci]" || echo "No changes"
    - git push origin HEAD:main
  only:
    - main
